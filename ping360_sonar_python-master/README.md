# ping360_sonar
[![GitHub stars](https://img.shields.io/github/stars/CentraleNantesRobotics/ping360_sonar.svg?style=social&label=Star&maxAge=2592000)](https://GitHub.com/CentraleNantesRobotics/ping360_sonar/stargazers/)
[![GitHub forks](https://img.shields.io/github/forks/CentraleNantesRobotics/ping360_sonar.svg?style=social&label=Fork&maxAge=2592000)](https://GitHub.com/CentraleNantesRobotics/ping360_sonar/network/)
[![Build Status](https://github.com/CentraleNantesRobotics/ping360_sonar/workflows/ROS%20CI/badge.svg)](https://GitHub.com/CentraleNantesRobotics/ping360_sonar/)
[![GitHub issues](https://img.shields.io/github/issues/CentraleNantesRobotics/ping360_sonar.svg)](https://GitHub.com/CentraleNantesRobotics/ping360_sonar/issues/)
[![GitHub license](https://img.shields.io/github/license/CentraleNantesRobotics/ping360_sonar.svg)](https://github.com/CentraleNantesRobotics/ping360_sonar/blob/master/LICENSE)
[![Github all releases](https://img.shields.io/github/downloads/CentraleNantesRobotics/ping360_sonar/total.svg)](https://GitHub.com/CentraleNantesRobotics/ping360_sonar/releases/)
[![GitHub release](https://img.shields.io/github/release/CentraleNantesRobotics/ping360_sonar.svg)](https://GitHub.com/CentraleNantesRobotics/ping360_sonar/releases/)
[![All Contributors](https://img.shields.io/badge/all_contributors-1-orange.svg?style=flat-square)](#contributors-)
## Overview

A python ROS package for the [BlueRobotics] [Ping360] Sonar. The package has been tested under [ROS] melodic and Ubuntu 16.04. This code is mostly experimental, expect that it changes often.

**Keywords:** ROS, package, ping360, ping360 emulator

### License

The source code is released under a [MIT license](LICENSE).

## Installation

### Download the latest release

Get the latest stable release [here](https://github.com/CentraleNantesRobotics/ping360_sonar/releases/latest).

### Building from Source

#### Dependencies

- [Robot Operating System (ROS)](http://wiki.ros.org) (middleware for robotics),
- OpenCV
- [cv_bridge]

#### Building

Before building from source, install [ping-protocol python lib](https://pypi.org/project/bluerobotics-ping/):

	pip install bluerobotics-ping

To build from source, clone the latest version from this repository into your catkin workspace and compile the package using

	cd catkin_workspace/src
	git clone https://github.com/CentraleNantesRobotics/ping360_sonar.git
	cd ../
	catkin build

### Unit Tests

TODO

## Usage

An example launch file has been provided [example.launch](launch/example.launch):

Run the main node with:

	roslaunch ping360_sonar example.launch

## Launch files

* **example.launch:** contains the default parameteres to run the Ping360 Sonar, including the serial port and the baudrate to interface with the sonar. The rest of the parameters are documented here: [Ping360 Documentation](https://docs.bluerobotics.com/ping-protocol/pingmessage-ping360/). The same parameters can also be reconfigured using the [dynamic_reconfigure](http://wiki.ros.org/dynamic_reconfigure).

	An emulated mode was added to test the package when you don't have the sonar. To run the emulated sonar, set the env variable to "true":

		<env name="emulated_sonar" value="true" />

	The results from the emulation should be:

![alt img](https://github.com/CentraleNantesRobotics/ping360_sonar/blob/master/img/print.png)

	
    Three extra parameters can be set to toggle specific topics, they are set to true by default.
	
        <param name="enableImageTopic" value="True"/> 
        <param name="enableScanTopic" value="True"/> 
        <param name="enableDataTopic" value="True"/>

## Nodes

### ping360_node

While continuously rotating the sonar, it publishes two types of messages:
- The sonar's response data (the echo intensities for a given angle & range)
- A black and white image using the date received from the sonar. Same as the one generated by the ping viewer.


#### Published Topics

* **`/ping360_node/sonar/images`** ([sensor_msgs/Image])

	The generated sonar image. 
	This topic can be toggled using the **enableImageTopic** parameter.

* **`/ping360_node/sonar/data`** ([msg/SonarEcho])

	Publishes the raw sonar data in a custom message:
	
		Header header            #header info
		float32 angle               # the measurement angle [rad]
		uint8 gain  # Sonar Gain
		uint16 number_of_samples 
		uint16 transmit_frequency # [kHz]
		uint16 speed_of_sound # [m/s]
		uint8 range      #  range value [m]
		uint8[] intensities    # intensity data [0-255].  This is the actual data received from the sonar
	
	This topic can be toggled using the **enableDataTopic** parameter.

* **`/ping360_node/sonar/scan`** ([sensor_msgs/LaserScan])

	Publishes a LaserScan msg with ranges detected with a certain intensity threshold:

		float32 angle_min = 0     # start angle of the scan [rad]
		float32 angle_max = 2*pi  # end angle of the scan [rad]
		float32 angle_increment   # angular distance between measurements, calculated using the configured Step  [rad]

		float32 range_min = .75   # minimum range value [m]
		float32 range_max = sonarRange # maximum range value, it's set to the configured sonarRange [m]

		float32[] ranges         # calculated ranges that correspond to an intensity > threshold [m] 
		float32[] intensities    # sensor intensity data [0-255]

	This topic can be toggled using the **enableScanTopic** parameter.

	Note: 
	- ranges values < range_min or > range_max should be discarded
	- don't forget to set the frame to *sonar_frame* when using Rviz

## Bugs & Feature Requests

Please report bugs and request features using the [Issue Tracker](https://github.com/CentraleNantesRobotics/ping360_sonar/issues).


[ROS]: http://www.ros.org
[BlueRobotics]: http://bluerobotics.com
[cv_bridge]: http://wiki.ros.org/cv_bridge
[sensor_msgs/Image]: http://docs.ros.org/melodic/api/sensor_msgs/html/msg/Image.html
[Ping360]: https://bluerobotics.com/store/sensors-sonars-cameras/sonar/ping360-sonar-r1-rp/
[msg/SonarEcho]: /msg/SonarEcho.msg
[sensor_msgs/LaserScan]: http://docs.ros.org/melodic/api/sensor_msgs/html/msg/LaserScan.html

## Contributors

<!-- ALL-CONTRIBUTORS-LIST:START - Do not remove or modify this section -->
<!-- prettier-ignore-start -->
<!-- markdownlint-disable -->
<table>
  <tr>
    <td align="center"><a href="https://github.com/Hameck"><img src="https://avatars2.githubusercontent.com/u/14954732?v=4" width="100px;" alt=""/><br /><sub><b>Henrique Martinez Rocamora</b></sub></a><br /><a href="https://github.com/CentraleNantesRobotics/ping360_sonar/commits?author=Hameck" title="Code">üíª</a> <a href="https://github.com/CentraleNantesRobotics/ping360_sonar/commits?author=Hameck" title="Tests">‚ö†Ô∏è</a></td>
    <td align="center"><a href="https://stormix.co"><img src="https://avatars2.githubusercontent.com/u/18377687?v=4" width="100px;" alt=""/><br /><sub><b>Anas Mazouni</b></sub></a><br /><a href="https://github.com/CentraleNantesRobotics/ping360_sonar/commits?author=Stormiix" title="Code">üíª</a> <a href="https://github.com/CentraleNantesRobotics/ping360_sonar/commits?author=Stormiix" title="Tests">‚ö†Ô∏è</a></td>
    <td align="center"><a href="https://github.com/tomlogan501"><img src="https://avatars3.githubusercontent.com/u/56969577?v=4" width="100px;" alt=""/><br /><sub><b>tomlogan501</b></sub></a><br /><a href="#ideas-tomlogan501" title="Ideas, Planning, & Feedback">ü§î</a> <a href="https://github.com/CentraleNantesRobotics/ping360_sonar/commits?author=tomlogan501" title="Tests">‚ö†Ô∏è</a> <a href="https://github.com/CentraleNantesRobotics/ping360_sonar/issues?q=author%3Atomlogan501" title="Bug reports">üêõ</a></td>
  </tr>
</table>

<!-- markdownlint-enable -->
<!-- prettier-ignore-end -->
<!-- ALL-CONTRIBUTORS-LIST:END -->

This project follows the [all-contributors](https://github.com/all-contributors/all-contributors) specification. 

Contributions of any kind welcome! Please refer to our [Contribution Guide](CONTRIBUTING.md)

